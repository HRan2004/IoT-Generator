
# 代码转译设计方案

## 一、设备直连

### 1.1 触发形式

接口到接口采用事件形式，数据每次变化，触发对方接口的事件，事件包含数据。


### 1.2 数据转型

用数据包形式，输出时包含多种数据类型，输入时取所需数据类型。

```ts
batch = {
  device: {
    name: 'device',
    category: 'sensor',
    model: 'xxx.xxxx.xxx',
  },
  data: {
    int: 1, 
    float: 1.1,
    string: '1.1',
    bool: true, 
    percent: 0.1, // %.3f
    real: ['ElectricCurrent', 'A', 1.1, 'float'], // [type, unit, value, jsType]
  }
}
```


## 二、逻辑板

### 2.1 触发形式

i. 初次启动时触发

ii. 循环触发

iii. 定时触发

iv. 由输入接口事件触发


### 2.2 数据转型

只传入设备数据包中的关键数据，由用户选择的逻辑块决定。

由用户自定义数学算法，进行数据转换。


### 2.3 逻辑板数据包

根据接口所连接节点类型，当连接至其他设备时，采用与设备数据包相同格式。

当连接至逻辑板时，采用js原生数据格式。


## 三、多端状态管理与同步

### 3.1 多端状态储存

状态在本地同时储存当前运行中状态，与云端设备真实状态。

本地状态采用触发形式才可修改，类似于react中useState()。

云端状态仅做数据记录，采用字典格式直接储存。


### 3.2 连锁触发

当需要连锁触发时，现在本地状态中进行事件连锁触发，再一并同步至云端。


### 3.2 上下行同步

采用队列管理器。当有连锁变化时，等待触发一并完成，一同进行上传。

上传时如有失败，则标记状态，并在后续重新上传。如果成功，则从队列中移除。

下传更新状态时，需检查是否与队列重复。删除队列中的上传数据，并仅在数据不同时触发本地连锁变化。


## 四、项目结构

分为3个部分。正常情况各为一个压缩js文件。

### 4.1 核心SDK

用于设备的接口属性的上传与下载，主要用于对接云端设备。

### 4.2 辅助文件

用于辅助代码生成，包含工具包，同步队列管理，状态管理等功能。

### 4.3 生成代码

此文件根据用户内容生成，只包含最精简的逻辑代码。配合辅助文件达成效果。


## 五、保密性设计

### 5.1 前端权限权限及功能限制

只在前端保持最基本的结构记录功能，代码生成及sdk内容，全接收至服务端实现。

### 5.2 代码混淆及压缩

将多个js文件合并至一个文件，并进行压缩为一个.min.js文件，可再进行zip压缩。

使用常量变量混淆，以及逻辑混淆框架，保护代码不便于阅读，并无法复原。

<br/>

# 工期与报价

### 第一部分 基本开发&流程对接 (7天 19k)

1. 前后端对接结构搭建
</br> · 全部内容在后端开发，前端仅保留最基本的结构。
</br> · 搭建后端项目，部署服务端并配置公网环境，与前端项目对接。
</br> · 以HTTP协议JSON格式传输，在服务端分配任务号，保留每次结果。
2. 设备直连代码生成
</br> · 两设备连线直连时，以事件形式，一方数据更新触发另一方变化事件。
3. 多端状态管理开发
</br> · 同时缓存云端状态，与本地状态，本地状态可修改，云端状态只做记录。
</br> · 云端状态仅在本地上传成功，或轮询发现状态变化时更新。
</br> · 本地状态变化事件由云端状态更新触发。
4. 下行监听更新开发
</br> · 云端状态更新时，触发本地状态更新。
5. 小应用平台对接测试
</br> · 与小应用平台对接，测试代码生成及上传功能，跑通整体流程。

### 第二部分 生成代码&各模块开发 (11天 28k)

1. 逻辑板代码生成及对接
</br> · 生成逻辑板代码，对接各接口。
</br> · 管理逻辑板主动触发事件 初始化,定时执行等功能。
</br> · 逻辑板数据包结构，对接设备采用设备数据包，对接逻辑板采用JS格式。
2. 数据包类型自动转换模块
</br> · 设备输出数据包生成。包含设备信息，接口信息及多类型数据。
</br> · 接收端数据选择与处理转换。
</br> · 预留自定义对接接口，可自定义特殊数据转换接口。
3. 各类主动启动触发事件管理
</br> · 运行状态触发器（程序启动，持续循环，网络错误，执行错误等）。
</br> · 定时触发器（每天/周定时触发，一次性触发等）。
4. 连锁触发事件管理
</br> · 本地进行状态连锁改变，合并上传至云端。
</br> · 属性事件表，连锁触发校验。
5. 局部异常管理
</br> · 任何局部事件内运行异常与外部隔离，不影响整体运行，记录错误信息及堆栈。

### 第三部分 安全性及结构完善 (2天 4k)

1. 代码后端多文件合并
</br> · 将多个js文件压缩为一个.min.js文件。
2. 逻辑混淆&常量变量混淆
</br> · 代码混淆，保护代码不便于阅读，并无法复原。
3. zip压缩及对接小应用平台
</br> · 代码压缩为zip格式，对接至小应用平台。

<br/>
<br/>
<br/>
